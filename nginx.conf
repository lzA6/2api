events {
    worker_connections 1024;
}

http {
    # 定义你的克隆士兵军团
    # Nginx 会自动找到所有名为 'z-ai2api' 的容器实例
    upstream z_ai_workers {
        # 'z-ai2api' 是我们在 docker-compose.yml 中定义的服务名
        # Docker 的内部 DNS 会解析它，并把所有工人的 IP 地址都加进来
        server z-ai2api:8080;
    }

    server {
        # 这是你帝国的唯一入口，所有请求都从这里进来
        listen 8084;

        location / {
            # 将请求转发给你的工人大军
            proxy_pass http://z_ai_workers;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 确保流式响应和 WebSocket 正常工作
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_buffering off; # 关键！关闭缓冲，让数据流实时通过
        }
    }
}
